exports.id=2399,exports.ids=[2399],exports.modules={8261:(a,b,c)=>{"use strict";c.r(b),c.d(b,{calculateFollowerQuantity:()=>k,generateId:()=>s,getOrderMappings:()=>q,loadActiveFollowers:()=>m,recordTradeEvent:()=>p,replicateTradeToFollowers:()=>n,syncExitOrder:()=>r,validateFollowerOrder:()=>l,validateOrderType:()=>i,validateProductType:()=>j,validateSymbol:()=>h});var d=c(35552),e=c(34032),f=c(55511),g=c.n(f);function h(a,b){return!b||0===b.length||b.includes(a.toUpperCase())}function i(a,b){return!b||0===b.length||b.includes(a.toUpperCase())}function j(a,b){return!a||!b||0===b.length||b.includes(a.toUpperCase())}function k(a,b){let c=Math.floor(a*b.lot_multiplier);return c>b.max_quantity?{quantity:c=b.max_quantity,reason:`Capped to max_quantity: ${b.max_quantity}`}:0===c?{quantity:0,reason:`Quantity becomes 0 after multiplier: ${b.lot_multiplier}`}:{quantity:c}}function l(a,b){if(!b.enabled)return{valid:!1,reason:"Account is disabled"};if(!h(a.symbol,b.allowed_instruments))return{valid:!1,reason:`Symbol ${a.symbol} not in allowed instruments`};if(a.order_type&&!i(a.order_type,b.allowed_order_types))return{valid:!1,reason:`Order type ${a.order_type} not allowed`};if(a.product_type&&!j(a.product_type,b.allowed_product_types))return{valid:!1,reason:`Product type ${a.product_type} not allowed`};if(a.price&&b.max_order_value){let c=a.quantity*a.price;if(c>b.max_order_value)return{valid:!1,reason:`Order value ₹${c} exceeds max: ₹${b.max_order_value}`}}return{valid:!0}}async function m(){let a=await (0,d.C)();if(!a)throw Error("Database connection failed");let b=`
    SELECT 
      fc.follower_id, 
      fc.client_id, 
      fc.api_key, 
      fc.access_token, 
      fc.broker_session_id,
      fc.status,
      rc.lot_multiplier,
      rc.max_quantity,
      rc.max_order_value,
      rc.max_daily_loss,
      rc.allowed_instruments,
      rc.allowed_product_types,
      rc.allowed_order_types,
      rc.enabled
    FROM follower_credentials fc
    LEFT JOIN follower_risk_config rc ON fc.follower_id = rc.follower_id
    WHERE fc.status = 'ACTIVE'
  `;return(await a.query(b)).map(a=>({id:a.follower_id,client_id:a.client_id,api_key:a.api_key,access_token:a.access_token,broker_session_id:a.broker_session_id,status:a.status,risk_config:{lot_multiplier:a.lot_multiplier||1,max_quantity:a.max_quantity||100,max_order_value:a.max_order_value,max_daily_loss:a.max_daily_loss,allowed_instruments:a.allowed_instruments?JSON.parse(a.allowed_instruments):void 0,allowed_product_types:a.allowed_product_types?JSON.parse(a.allowed_product_types):void 0,allowed_order_types:a.allowed_order_types?JSON.parse(a.allowed_order_types):void 0,enabled:!1!==a.enabled}}))}async function n(a,b,c){let d=[];try{let e=await m(),f=c&&c.length>0?e.filter(a=>c.includes(a.id)):e;if(c&&c.length>0&&0===f.length)return c.map(a=>({follower_id:a,status:"FAILED",reason:"Follower not found or not active"}));for(let c of f){let e=await o(a,c,b);d.push(e)}}catch(a){console.error("Error replicating trades:",a)}return d}async function o(a,b,c){let f=await (0,d.C)();if(!f)return{follower_id:b.id,status:"FAILED",reason:"Database connection failed"};try{let c,d=(await f.query("SELECT copy_trading_active FROM follower_consents WHERE follower_id = ?",[b.id]))[0];if(d&&!d.copy_trading_active)return{follower_id:b.id,status:"SKIPPED",reason:"Copy trading disabled for this follower"};let g=l(a,b.risk_config);if(!g.valid)return{follower_id:b.id,status:"SKIPPED",reason:g.reason};let{quantity:h,reason:i}=k(a.quantity,b.risk_config);if(0===h)return{follower_id:b.id,status:"SKIPPED",reason:i||"Quantity becomes 0 after multiplier"};let j=s();await f.query(`
      INSERT INTO order_mappings 
      (id, master_order_id, follower_id, symbol, exchange, side, quantity, product_type, status, created_at, updated_at)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, 'PENDING', NOW(), NOW())
      `,[j,a.id,b.id,a.symbol,a.exchange||"NSE",a.side,h,a.product_type||"MIS"]);try{console.log(`[ALICE-BLUE] Placing order for follower ${b.id}:`,{symbol:a.symbol,side:a.side,quantity:h,price:a.price});let d=await (0,e.v3)(b.id,{id:a.id,symbol:a.symbol,side:a.side,qty:h,quantity:h,price:a.price,type:a.order_type||"MARKET"},{apiKey:b.api_key,clientId:b.client_id,sessionToken:b.broker_session_id});if(!(c=d?.orderId||d?.order_id||d?.id))throw Error(`No order ID returned from Alice Blue: ${JSON.stringify(d)}`);console.log(`[ALICE-BLUE] Order placed successfully for ${b.id}: ${c}`)}catch(c){let a=c.message||"Failed to place order on Alice Blue";return console.error(`[ALICE-BLUE-ERROR] Follower ${b.id}:`,a),await f.query("UPDATE order_mappings SET status = 'FAILED', error_message = ?, updated_at = NOW() WHERE id = ?",[a,j]),{follower_id:b.id,status:"FAILED",reason:`Alice Blue API error: ${a}`,order_mapping_id:j}}return await f.query("UPDATE order_mappings SET follower_order_id = ?, status = 'ACTIVE', executed_quantity = ?, updated_at = NOW() WHERE id = ?",[c,h,j]),{follower_id:b.id,status:"SUCCESS",follower_order_id:c,executed_quantity:h,order_mapping_id:j}}catch(a){return{follower_id:b.id,status:"FAILED",reason:a.message||"Unknown error"}}}async function p(a,b,c){let e=await (0,d.C)();if(!e)throw Error("Database connection failed");let f=s(),g=c.filter(a=>"SUCCESS"===a.status).length,h=c.filter(a=>"FAILED"===a.status).length,i=c.filter(a=>"SKIPPED"===a.status).length;return await e.query(`
    INSERT INTO trade_events 
    (id, master_order_id, event_type, symbol, exchange, side, quantity, product_type, order_type, price, total_followers, successful_followers, failed_followers, skipped_followers, processed_at)
    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, NOW())
    `,[f,a.id,b,a.symbol,a.exchange||"NSE",a.side,a.quantity,a.product_type||"MIS",a.order_type||"MARKET",a.price||0,c.length,g,h,i]),f}async function q(a){let b=await (0,d.C)();if(!b)throw Error("Database connection failed");return await b.query("SELECT * FROM order_mappings WHERE master_order_id = ? ORDER BY created_at DESC",[a])}async function r(a){let b=await (0,d.C)();if(!b)throw Error("Database connection failed");let c=await q(a),e=[];for(let a of c)try{if("CANCELLED"===a.status||!a.follower_order_id){e.push({follower_id:a.follower_id,status:"SKIPPED",reason:`Order already ${a.status.toLowerCase()} or no order ID`});continue}let c=await b.query(`SELECT fc.*, rc.lot_multiplier FROM follower_credentials fc
         LEFT JOIN follower_risk_config rc ON fc.follower_id = rc.follower_id
         WHERE fc.follower_id = ?`,[a.follower_id]);if(!c||0===c.length)throw Error("Follower credentials not found");let d=c[0];console.log(`[EXIT-ORDER] Cancelling order ${a.follower_order_id} for follower ${a.follower_id}`);try{let b=await fetch(`${process.env.ALICE_API_BASE_URL}/orders/${a.follower_order_id}/cancel`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${d.access_token}`,"x-api-key":d.api_key}}).then(a=>a.json());if(!b.ok&&200!==b.status)throw Error(`Alice Blue cancel failed: ${JSON.stringify(b)}`);console.log(`[EXIT-ORDER] Successfully cancelled ${a.follower_order_id}`)}catch(a){console.warn("[EXIT-ORDER] Alice Blue cancel call failed, will mark as cancelled in DB anyway:",a)}await b.query("UPDATE order_mappings SET status = 'CANCELLED', updated_at = NOW() WHERE id = ?",[a.id]),e.push({follower_id:a.follower_id,status:"SUCCESS",reason:"Exit order processed"})}catch(b){console.error(`[EXIT-ORDER-ERROR] Follower ${a.follower_id}:`,b),e.push({follower_id:a.follower_id,status:"FAILED",reason:b.message||"Unknown error"})}return e}function s(){return`${Date.now()}-${g().randomBytes(4).toString("hex")}`}},28303:a=>{function b(a){var b=Error("Cannot find module '"+a+"'");throw b.code="MODULE_NOT_FOUND",b}b.keys=()=>[],b.resolve=b,b.id=28303,a.exports=b},34032:(a,b,c)=>{"use strict";c.d(b,{MQ:()=>j,Pc:()=>n,UC:()=>o,fn:()=>i,m8:()=>m,v3:()=>p});var d=c(55511),e=c.n(d),f=c(29021),g=c.n(f);async function h(a,b={},c=3,d=500){let e=0;for(;e<=c;)try{let c=await fetch(a,b);if(!c.ok){let a=await c.text().catch(()=>"");throw Error(`HTTP ${c.status}: ${a}`)}return c}catch(a){if(e===c)throw a;await new Promise(a=>setTimeout(a,d*Math.pow(2,e))),e++}throw Error("Unreachable")}function i(a,b,c,d,f,g){let h={"Content-Type":"application/json"};if(g)return h.Authorization=`Bearer ${g}`,h;let i=(c||"headers").toLowerCase();if("basic"===i)h.Authorization=`Basic ${Buffer.from(`${a}:${b}`).toString("base64")}`;else if("hmac"===i){let c=Math.floor(Date.now()/1e3).toString(),g=new URL(d),i=g.pathname+(g.search||""),j=`${c}:${i}:${f??""}`,k=e().createHmac("sha256",b).update(j).digest("hex");h["x-api-key"]=a,h["x-timestamp"]=c,h["x-signature"]=k}else h["x-api-key"]=a,h["x-api-secret"]=b;return h}async function j(){let a=process.env.ALICE_TRADES_ENDPOINT||process.env.ALICE_API_BASE_URL,b=process.env.ALICE_API_KEY,d=process.env.ALICE_API_SECRET;if(!a){let{trades:a}=await c.e(7306).then(c.bind(c,47306));return a.filter(a=>"Master"===a.account)}let e=process.env.ALICE_OAUTH_TOKEN,f=process.env.ALICE_OAUTH_TOKEN_FILE||".alice.token",j=e;if(!j&&g().existsSync(f))try{j=g().readFileSync(f,"utf-8").trim()}catch(a){console.warn("Failed reading token file",f,a)}if(!b&&!j){let{trades:a}=await c.e(7306).then(c.bind(c,47306));return a.filter(a=>"Master"===a.account)}let k=i(b??"",d??"",process.env.ALICE_AUTH_METHOD,a,void 0,j),l=await h(a,{headers:k}),m=await l.json().catch(()=>({})),n=m.trades||m.data||m||[];return(Array.isArray(n)?n:[]).map((a,b)=>({id:a.id??a.tradeId??`A-${Date.now()}-${b}`,timestamp:a.timestamp??a.time??new Date().toISOString(),account:process.env.ALICE_MASTER_ACCOUNT??"Master",symbol:a.symbol??a.instrument??a.scrip??a.ticker??"",type:a.type??"Market",side:a.side??a.buySell??("SELL"===a.transactionType?"Sell":"Buy"),quantity:Number(a.quantity??a.qty??a.quantityFilled??0),price:Number(a.price??a.rate??a.fillPrice??0),status:a.status??"Filled"}))}let k=process.env.ALICE_OAUTH_TOKENS_FILE||".alice.tokens.json";function l(){try{if(g().existsSync(k)){let a=g().readFileSync(k,"utf-8");return JSON.parse(a||"{}")}}catch(a){console.warn("Failed reading tokens file",k,a)}return{}}function m(a,b){if(!a)return;let c=l();c[a]=b;try{g().writeFileSync(k,JSON.stringify(c,null,2),{encoding:"utf-8",flag:"w"})}catch(a){console.error("Failed writing tokens file",k,a)}}function n(a){if(a)return l()[a]}async function o(a){let b=n(a||process.env.ALICE_MASTER_ACCOUNT||"Master");if(b){let c=process.env.ALICE_OAUTH_TRADES_ENDPOINT||"https://ant.aliceblueonline.com/open-api/od/v1/trades";try{let d={"Content-Type":"application/json",Authorization:`Bearer ${b}`};console.log(`[ALICE] Fetching trades for ${a} via OAuth endpoint: ${c}`);let e=await h(c,{headers:d}),f=await e.json().catch(()=>({})),g=f.trades||f.data||f||[];return console.log(`[ALICE] OAuth fetch for ${a}: received ${Array.isArray(g)?g.length:0} trades`),(Array.isArray(g)?g:[]).map((b,c)=>({id:b.id??b.tradeId??`A-${Date.now()}-${c}`,timestamp:b.timestamp??b.time??new Date().toISOString(),account:a??process.env.ALICE_MASTER_ACCOUNT??"Master",symbol:b.symbol??b.instrument??b.scrip??b.ticker??"",type:b.type??"Market",side:b.side??b.buySell??("SELL"===b.transactionType?"Sell":"Buy"),quantity:Number(b.quantity??b.qty??b.quantityFilled??0),price:Number(b.price??b.rate??b.fillPrice??0),status:b.status??"Filled"}))}catch(b){console.error(`[ALICE] OAuth endpoint failed for ${a}:`,b)}}let d=process.env.ALICE_TRADES_ENDPOINT||process.env.ALICE_API_BASE_URL,e=process.env.ALICE_API_KEY,f=process.env.ALICE_API_SECRET;if(!d||!e&&!b){let{trades:b}=await c.e(7306).then(c.bind(c,47306));return b.filter(b=>!a||b.account===(a||"Master"))}let g=i(e??"",f??"",process.env.ALICE_AUTH_METHOD,d,void 0,b),j=await h(d,{headers:g}),k=await j.json().catch(()=>({})),l=k.trades||k.data||k||[];return(Array.isArray(l)?l:[]).map((b,c)=>({id:b.id??b.tradeId??`A-${Date.now()}-${c}`,timestamp:b.timestamp??b.time??new Date().toISOString(),account:a??process.env.ALICE_MASTER_ACCOUNT??"Master",symbol:b.symbol??b.instrument??b.scrip??b.ticker??"",type:b.type??"Market",side:b.side??b.buySell??("SELL"===b.transactionType?"Sell":"Buy"),quantity:Number(b.quantity??b.qty??b.quantityFilled??0),price:Number(b.price??b.rate??b.fillPrice??0),status:b.status??"Filled"}))}async function p(a,b,c){let d=process.env.ALICE_ORDER_ENDPOINT||(process.env.ALICE_API_BASE_URL?`${process.env.ALICE_API_BASE_URL.replace(/\/$/,"")}/orders`:void 0);if(!d)throw Error("ALICE_ORDER_ENDPOINT not configured");let e=c?.sessionToken||n(a),f=c?.apiKey||process.env.ALICE_API_KEY||"",g=i(f,c?.clientId||process.env.ALICE_API_SECRET||"",process.env.ALICE_AUTH_METHOD,d,void 0,e),j={symbol:b.symbol,transactionType:"SELL"===(b.side||"Buy").toString().toUpperCase()?"SELL":"BUY",quantity:Number(b.qty||b.quantity||0),orderType:(b.type||"Market").toString().toUpperCase(),price:Number(b.price||0),clientOrderId:b.id},k=await h(d,{method:"POST",headers:g,body:JSON.stringify(j)});return await k.json().catch(()=>({}))}},35552:(a,b,c)=>{"use strict";c.d(b,{C:()=>e});let d=c(29382).createPool({host:process.env.DB_HOST,user:process.env.DB_USER,password:process.env.DB_PASS,database:process.env.DB_NAME});async function e(){return d}},78335:()=>{},96487:()=>{}};